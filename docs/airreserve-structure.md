# Airリザーブの構造情報

## 概要

このドキュメントは、Airリザーブ予約システムの構造とスクレイピングに必要な情報をまとめたものです。

## カレンダー表示形式

### 基本構造

- **表示単位**: 1週間（月曜日〜日曜日）
- **表示方向**: 横並び（7日分が横に並ぶ）
- **縦軸**: 時間帯
- **ページ遷移**: 「次週」ボタンで次の週へ移動

### HTML構造

#### 週情報
```html
<li class="ctlListItem listDate">2025/10/27(月) 〜 11/03(月)</li>
```
- セレクター: `.ctlListItem.listDate`
- 形式: `YYYY/MM/DD(曜日) 〜 MM/DD(曜日)`

#### 次週ボタン
```html
<li class="ctlListItem listNext">次週</li>
```
- セレクター: `.ctlListItem.listNext`
- クリックで次週のカレンダーに遷移

#### イベント要素
```html
<div class="dataLinkBox js-dataLinkBox">
  <a href="予約URL">
    09:30
    イベント名
    残○ /定員○
  </a>
</div>
```
- セレクター: `.dataLinkBox.js-dataLinkBox`
- 内部に`<a>`タグで予約リンクを含む

## 予約可能枠の判定

### 予約可能を示すキーワード

- `残` - 残席数（例: 残7、残15）
- `仮` - 仮予約受付
- `待` - キャンセル待ち受付

### 予約不可を示すキーワード

- `残0` - 残席なし
- `満員` - 満席
- `受付終了` - 受付期間終了
- `LINE予約` - LINE経由の予約（Airリザーブからは予約不可）

### 判定ロジックの注意点

1. **「満」の扱い**: 「満員」は除外するが、「定員」に含まれる「員」と誤判定しないよう、「満員」のみを除外キーワードとする
2. **LINE予約の除外**: テキストに「line予約」または「ここはline」が含まれる場合は除外
3. **残0の優先チェック**: 他のキーワードより先に「残0」をチェック

## テストサイトと本番サイトの違い

### テストサイト（platkokoro2020）

- **URL**: `https://airrsv.net/platkokoro2020/calendar`
- **受付開始**: 14日前の13時から
- **特徴**: カレンダーに「残○」と表示されていても、14日前より先のイベントは予約ページで「予約受付期間外です。別の時間帯をお探しください。」と表示される
- **判定方法**: 予約ページに遷移後、エラーメッセージの有無で判定

### 本番サイト（kokoroto-azukari）

- **URL**: `https://airrsv.net/kokoroto-azukari/calendar`
- **受付開始**: 即座（残席があれば予約可能）
- **特徴**: カレンダーに「残○」があれば即座に予約可能

### 実装方針

**カレンダー段階での判定（現在実装中）**
- 14日前の計算は複雑で誤差が出やすい
- ❌ 推奨しない

**予約ページ遷移後の判定（推奨）**
- 予約リンクをクリック
- ページ遷移後に「予約受付期間外です」のメッセージをチェック
- メッセージがあれば対象外、なければ予約可能
- ✅ シンプルで確実

## 実装上の設定

### 環境変数

```bash
# テストサイトの場合
TARGET_URL=https://airrsv.net/platkokoro2020/calendar
TEST_SITE_MODE=true

# 本番サイトの場合
TARGET_URL=https://airrsv.net/kokoroto-azukari/calendar
TEST_SITE_MODE=false
```

### スクレイピング設定

- **確認範囲**: 7週分（約1.5ヶ月先まで）
- **チェック間隔**: 1秒
- **監視時間**: 設定可能（デフォルト: 10分）

## セレクター一覧

| 要素 | セレクター | 説明 |
|------|-----------|------|
| 週情報 | `.ctlListItem.listDate` | 週の開始日と終了日 |
| 次週ボタン | `.ctlListItem.listNext` | 次週へ遷移 |
| イベント | `.dataLinkBox.js-dataLinkBox` | 予約可能なイベント |
| 予約リンク | `.dataLinkBox.js-dataLinkBox a` | イベント内の予約リンク |

## 予約フロー（未実装）

1. イベントをクリック
2. メニュー選択
3. 日時選択
4. 予約者情報入力
5. 確認画面
6. 予約完了

---

**作成日**: 2025年10月27日  
**最終更新**: 2025年10月27日

